<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip 상황 공유</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .skeleton { background-color: #e5e7eb; border-radius: 0.25rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-4">
    <div class="max-w-lg mx-auto space-y-4">

        <!-- 1단계: 최초 상황 정보 -->
        <div id="stage1-card" class="card p-5 fade-in">
            <header class="text-center border-b pb-4 mb-4">
                <h1 id="summary" class="text-xl font-bold text-gray-800 flex items-center justify-center">
                    <i class="fas fa-bolt mr-3 text-red-500"></i>
                    <span>-</span>
                </h1>
                <p id="initialReportTime" class="text-sm text-gray-500 mt-1">-</p>
            </header>
            <div>
                <h2 class="font-semibold text-gray-700 mb-2">담당자</h2>
                <p id="personnel" class="text-gray-600 bg-gray-50 p-2 rounded-md">-</p>
            </div>
        </div>

        <!-- 2단계: AI 분석 결과 (초기에는 숨겨져 있음) -->
        <div id="stage2-card" class="card p-5 hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2 flex items-center">
                <i class="fas fa-brain mr-3 text-blue-500"></i>AI 분석 결과
            </h2>
            <div class="space-y-3 text-gray-700">
                <div>
                    <p class="text-sm font-semibold">추정 원인 (신뢰도 <span id="confidence" class="font-bold text-green-600">-%</span>)</p>
                    <p id="cause" class="font-bold text-lg text-red-600">-</p>
                </div>
                <div>
                    <p class="text-sm font-semibold">권장 조치 (1순위)</p>
                    <p id="recommendation" class="bg-blue-50 p-2 rounded-md">-</p>
                </div>
                <div>
                    <p class="text-sm font-semibold">유사 과거 사례</p>
                    <p id="similar-case" class="text-sm text-gray-600">-</p>
                </div>
            </div>
        </div>

        <!-- 로딩 스켈레톤 UI -->
        <div id="loading-card" class="card p-5 fade-in">
            <div class="space-y-4">
                <div class="skeleton h-6 w-3/4 mx-auto"></div>
                <div class="skeleton h-4 w-1/2 mx-auto"></div>
                <div class="skeleton h-10 w-full mt-4"></div>
                <div class="skeleton h-16 w-full mt-2"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK 추가 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ❗ 중요: 여기에 본인의 Firebase 프로젝트 구성 정보를 붙여넣으세요.
        // Firebase 콘솔 > 프로젝트 설정(⚙️) > 일반 > 내 앱 > Firebase SDK 스니펫 > 구성(CDN)
        const firebaseConfig = {
            // 여기에 복사한 Firebase 구성 객체를 붙여넣으세요.
            // 예시:
            // apiKey: "AIzaSy...",
            // authDomain: "trip-dashboard-live.firebaseapp.com",
            // databaseURL: "https://trip-dashboard-live-default-rtdb.firebaseio.com",
            // projectId: "trip-dashboard-live",
            // storageBucket: "trip-dashboard-live.appspot.com",
            // messagingSenderId: "...",
            // appId: "..."
        };

        // Firebase 앱 초기화
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 화면 요소
        const summaryEl = document.getElementById('summary');
        const initialReportTimeEl = document.getElementById('initialReportTime');
        const personnelEl = document.getElementById('personnel');
        const stage1Card = document.getElementById('stage1-card');
        const stage2Card = document.getElementById('stage2-card');
        const loadingCard = document.getElementById('loading-card');
        const confidenceEl = document.getElementById('confidence');
        const causeEl = document.getElementById('cause');
        const recommendationEl = document.getElementById('recommendation');
        const similarCaseEl = document.getElementById('similar-case');

        // 페이지가 로드될 때 실행되는 메인 함수
        document.addEventListener('DOMContentLoaded', () => {
            // 1. URL에서 tripId 가져오기
            const params = new URLSearchParams(window.location.search);
            const tripId = params.get('tripId');

            if (!tripId) {
                showError("잘못된 접근입니다. 공유받은 URL을 확인해주세요.");
                return;
            }

            // 2. 해당 tripId의 '우편함'을 실시간으로 구독(감시) 시작
            const tripRef = database.ref(`trips/${tripId}`);
            tripRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (!data) {
                    showError("Trip 정보를 찾을 수 없습니다.");
                    return;
                }

                console.log("📬 새로운 데이터 수신:", data);
                updateUI(data);
            });
        });

        // 데이터를 기반으로 UI를 업데이트하는 함수
        function updateUI(data) {
            loadingCard.classList.add('hidden');
            stage1Card.classList.remove('hidden');

            // 1단계: 최초 상황 정보 업데이트 (항상 표시)
            if (data.stage1) {
                summaryEl.textContent = data.stage1.summary;
                initialReportTimeEl.textContent = `최초 보고: ${new Date(data.stage1.initialReportTime).toLocaleString('ko-KR')}`;
                personnelEl.textContent = data.stage1.personnel || '지정되지 않음';
            }

            // 2단계: AI 분석 결과 업데이트 (데이터가 있을 때만 표시)
            if (data.stage2) {
                const analysis = data.stage2;
                
                // 신뢰도, 추정 원인, 권장 조치 등 화면에 표시
                if(analysis.first_hit_analysis && analysis.first_hit_analysis.first_hit_alarms.length > 0) {
                    const firstHit = analysis.first_hit_analysis.first_hit_alarms[0];
                    confidenceEl.textContent = `${firstHit.final_score}%`;
                    causeEl.textContent = firstHit.message;
                }

                if(analysis.recommendations && analysis.recommendations.length > 0) {
                    recommendationEl.textContent = analysis.recommendations[0].content;
                }

                if(analysis.ai_analysis && analysis.ai_analysis.track1_system_auto.similar_case) {
                    similarCaseEl.textContent = `'${analysis.ai_analysis.track1_system_auto.similar_case.title}' 사례와 유사`;
                }
                
                // 숨겨져 있던 AI 분석 카드 표시
                stage2Card.classList.remove('hidden');
                stage2Card.classList.add('fade-in');
            }
        }

        // 오류 메시지를 표시하는 함수
        function showError(message) {
            loadingCard.classList.add('hidden');
            stage1Card.classList.remove('hidden');
            summaryEl.textContent = "오류";
            personnelEl.innerHTML = `<span class="text-red-500">${message}</span>`;
        }

    </script>
</body>
</html>
