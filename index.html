<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip ìƒí™© ê³µìœ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .skeleton { background-color: #e5e7eb; border-radius: 0.25rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-4">
    <div class="max-w-lg mx-auto space-y-4">

        <!-- 1ë‹¨ê³„: ìµœì´ˆ ìƒí™© ì •ë³´ -->
        <div id="stage1-card" class="card p-5 fade-in">
            <header class="text-center border-b pb-4 mb-4">
                <h1 id="summary" class="text-xl font-bold text-gray-800 flex items-center justify-center">
                    <i class="fas fa-bolt mr-3 text-red-500"></i>
                    <span>-</span>
                </h1>
                <p id="initialReportTime" class="text-sm text-gray-500 mt-1">-</p>
            </header>
            <div>
                <h2 class="font-semibold text-gray-700 mb-2">ë‹´ë‹¹ì</h2>
                <p id="personnel" class="text-gray-600 bg-gray-50 p-2 rounded-md">-</p>
            </div>
        </div>

        <!-- 2ë‹¨ê³„: AI ë¶„ì„ ê²°ê³¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
        <div id="stage2-card" class="card p-5 hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2 flex items-center">
                <i class="fas fa-brain mr-3 text-blue-500"></i>AI ë¶„ì„ ê²°ê³¼
            </h2>
            <div class="space-y-3 text-gray-700">
                <div>
                    <p class="text-sm font-semibold">ì¶”ì • ì›ì¸ (ì‹ ë¢°ë„ <span id="confidence" class="font-bold text-green-600">-%</span>)</p>
                    <p id="cause" class="font-bold text-lg text-red-600">-</p>
                </div>
                <div>
                    <p class="text-sm font-semibold">ê¶Œì¥ ì¡°ì¹˜ (1ìˆœìœ„)</p>
                    <p id="recommendation" class="bg-blue-50 p-2 rounded-md">-</p>
                </div>
                <div>
                    <p class="text-sm font-semibold">ìœ ì‚¬ ê³¼ê±° ì‚¬ë¡€</p>
                    <p id="similar-case" class="text-sm text-gray-600">-</p>
                </div>
            </div>
        </div>

        <!-- ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ UI -->
        <div id="loading-card" class="card p-5 fade-in">
            <div class="space-y-4">
                <div class="skeleton h-6 w-3/4 mx-auto"></div>
                <div class="skeleton h-4 w-1/2 mx-auto"></div>
                <div class="skeleton h-10 w-full mt-4"></div>
                <div class="skeleton h-16 w-full mt-2"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK ì¶”ê°€ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // â— ì¤‘ìš”: ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ êµ¬ì„± ì •ë³´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        // Firebase ì½˜ì†” > í”„ë¡œì íŠ¸ ì„¤ì •(âš™ï¸) > ì¼ë°˜ > ë‚´ ì•± > Firebase SDK ìŠ¤ë‹ˆí« > êµ¬ì„±(CDN)
        const firebaseConfig = {
            // ì—¬ê¸°ì— ë³µì‚¬í•œ Firebase êµ¬ì„± ê°ì²´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
            // ì˜ˆì‹œ:
            // apiKey: "AIzaSy...",
            // authDomain: "trip-dashboard-live.firebaseapp.com",
            // databaseURL: "https://trip-dashboard-live-default-rtdb.firebaseio.com",
            // projectId: "trip-dashboard-live",
            // storageBucket: "trip-dashboard-live.appspot.com",
            // messagingSenderId: "...",
            // appId: "..."
        };

        // Firebase ì•± ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // í™”ë©´ ìš”ì†Œ
        const summaryEl = document.getElementById('summary');
        const initialReportTimeEl = document.getElementById('initialReportTime');
        const personnelEl = document.getElementById('personnel');
        const stage1Card = document.getElementById('stage1-card');
        const stage2Card = document.getElementById('stage2-card');
        const loadingCard = document.getElementById('loading-card');
        const confidenceEl = document.getElementById('confidence');
        const causeEl = document.getElementById('cause');
        const recommendationEl = document.getElementById('recommendation');
        const similarCaseEl = document.getElementById('similar-case');

        // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ í•¨ìˆ˜
        document.addEventListener('DOMContentLoaded', () => {
            // 1. URLì—ì„œ tripId ê°€ì ¸ì˜¤ê¸°
            const params = new URLSearchParams(window.location.search);
            const tripId = params.get('tripId');

            if (!tripId) {
                showError("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ê³µìœ ë°›ì€ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                return;
            }

            // 2. í•´ë‹¹ tripIdì˜ 'ìš°í¸í•¨'ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ êµ¬ë…(ê°ì‹œ) ì‹œì‘
            const tripRef = database.ref(`trips/${tripId}`);
            tripRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (!data) {
                    showError("Trip ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                console.log("ğŸ“¬ ìƒˆë¡œìš´ ë°ì´í„° ìˆ˜ì‹ :", data);
                updateUI(data);
            });
        });

        // ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateUI(data) {
            loadingCard.classList.add('hidden');
            stage1Card.classList.remove('hidden');

            // 1ë‹¨ê³„: ìµœì´ˆ ìƒí™© ì •ë³´ ì—…ë°ì´íŠ¸ (í•­ìƒ í‘œì‹œ)
            if (data.stage1) {
                summaryEl.textContent = data.stage1.summary;
                initialReportTimeEl.textContent = `ìµœì´ˆ ë³´ê³ : ${new Date(data.stage1.initialReportTime).toLocaleString('ko-KR')}`;
                personnelEl.textContent = data.stage1.personnel || 'ì§€ì •ë˜ì§€ ì•ŠìŒ';
            }

            // 2ë‹¨ê³„: AI ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸ (ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ)
            if (data.stage2) {
                const analysis = data.stage2;
                
                // ì‹ ë¢°ë„, ì¶”ì • ì›ì¸, ê¶Œì¥ ì¡°ì¹˜ ë“± í™”ë©´ì— í‘œì‹œ
                if(analysis.first_hit_analysis && analysis.first_hit_analysis.first_hit_alarms.length > 0) {
                    const firstHit = analysis.first_hit_analysis.first_hit_alarms[0];
                    confidenceEl.textContent = `${firstHit.final_score}%`;
                    causeEl.textContent = firstHit.message;
                }

                if(analysis.recommendations && analysis.recommendations.length > 0) {
                    recommendationEl.textContent = analysis.recommendations[0].content;
                }

                if(analysis.ai_analysis && analysis.ai_analysis.track1_system_auto.similar_case) {
                    similarCaseEl.textContent = `'${analysis.ai_analysis.track1_system_auto.similar_case.title}' ì‚¬ë¡€ì™€ ìœ ì‚¬`;
                }
                
                // ìˆ¨ê²¨ì ¸ ìˆë˜ AI ë¶„ì„ ì¹´ë“œ í‘œì‹œ
                stage2Card.classList.remove('hidden');
                stage2Card.classList.add('fade-in');
            }
        }

        // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showError(message) {
            loadingCard.classList.add('hidden');
            stage1Card.classList.remove('hidden');
            summaryEl.textContent = "ì˜¤ë¥˜";
            personnelEl.innerHTML = `<span class="text-red-500">${message}</span>`;
        }

    </script>
</body>
</html>
